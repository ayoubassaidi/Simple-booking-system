{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Providers - Smart Service Booking</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Global Browse CSS -->
    <link rel="stylesheet" href="{% static 'css/browse.css' %}">
</head>
<body>
    <!-- Navigation Header -->
    <header class="header-nav">
        <div class="container">
            <a href="{% url 'home' %}" class="logo">Smart Booking</a>
            <div class="nav-buttons">
                {% if user.is_authenticated %}
                    <span class="user-type-badge">
                        {% if user.userprofile.user_type == 'provider' %}
                            <i class="bi bi-briefcase-fill"></i> Service Provider
                        {% else %}
                            <i class="bi bi-person-circle"></i> User
                        {% endif %}
                    </span>
                    <a href="{% url 'dashboard' %}" class="nav-btn nav-btn-login">Dashboard</a>
                    <a href="{% url 'logout' %}" class="nav-btn nav-btn-register">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="nav-btn nav-btn-login">Login</a>
                    <a href="{% url 'index' %}" class="nav-btn nav-btn-register">Register</a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Provider Alert (if logged in as provider) -->
    {% if user.is_authenticated and user.userprofile.user_type == 'provider' %}
    <div class="container mt-3">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Provider Account:</strong> You are logged in as a service provider. Providers cannot book services - only customers can make bookings.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}

    <!-- Search Hero Section -->
    <section class="search-hero">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="glow-text">Discover</span> Amazing Services
                </h1>
                <p class="hero-subtitle">Find the perfect service provider for your needs</p>
            </div>

            <!-- Search Form -->
            <form method="get" class="search-form-modern">
                <div class="row g-4 align-items-end">
                    <!-- Service Category Dropdown -->
                    <div class="col-lg-4 col-md-6">
                        <div class="input-group-modern">
                            <label for="category" class="form-label-modern">
                                <i class="bi bi-grid-3x3"></i> Category
                            </label>
                            <select name="category" id="category" class="form-select-modern">
                                <option value="">All Categories</option>
                                {% for value, label in category_choices %}
                                <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Search Input -->
                    <div class="col-lg-5 col-md-6">
                        <div class="input-group-modern">
                            <label for="search" class="form-label-modern">
                                <i class="bi bi-search"></i> Search
                            </label>
                            <div class="search-input-wrapper">
                                <input type="text" name="search" id="search" class="form-control-modern"
                                       placeholder="Hair styling, Math tutoring..."
                                       value="{{ search_query }}">
                                <i class="bi bi-search search-icon"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <div class="col-lg-3 col-md-12">
                        <button type="submit" class="btn-search-modern">
                            <span>Search Services</span>
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- Results Section -->
    <section class="results-section">
        <div class="container">
            <!-- Results Header -->
            <div class="results-header-modern">
                <div class="results-info">
                    <h2 class="results-title">
                        Available Services
                        <span class="badge-count">{{ services.count }}</span>
                    </h2>
                    <p class="results-subtitle">Explore our curated selection of professional services</p>
                </div>

                <!-- Sort Dropdown -->
                <div class="sort-wrapper">
                    <label for="sort_by" class="sort-label">
                        <i class="bi bi-filter"></i> Sort by
                    </label>
                    <select id="sort_by" name="sort_by" class="form-select-modern">
                        <option value="newest" {% if selected_sort == 'newest' %}selected{% endif %}>Newest First</option>
                        <option value="price_low" {% if selected_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_high" {% if selected_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                        <option value="duration" {% if selected_sort == 'duration' %}selected{% endif %}>Duration</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters -->
            {% if selected_category or search_query %}
            <div class="filter-pills-modern">
                <span class="filter-label"><i class="bi bi-funnel"></i> Active Filters:</span>
                {% if selected_category %}
                <span class="filter-pill-modern">
                    {{ selected_category|upper }}
                    <a href="?search={{ search_query }}&sort_by={{ selected_sort }}" class="remove-filter">
                        <i class="bi bi-x"></i>
                    </a>
                </span>
                {% endif %}

                {% if search_query %}
                <span class="filter-pill-modern">
                    "{{ search_query }}"
                    <a href="?category={{ selected_category }}&sort_by={{ selected_sort }}" class="remove-filter">
                        <i class="bi bi-x"></i>
                    </a>
                </span>
                {% endif %}

                <a href="?" class="btn-clear-filters">
                    <i class="bi bi-x-circle"></i> Clear All
                </a>
            </div>
            {% endif %}

            <!-- Service Cards -->
            {% if services %}
                <div class="row g-4">
                {% for service in services %}
                    <div class="col-md-6 col-lg-4">
                        <div class="service-card-modern">
                            <!-- Card Header with Glow -->
                            <div class="card-header-modern">
                                <div class="category-badge-modern">
                                    <i class="bi bi-star-fill"></i>
                                    {{ service.get_category_display }}
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body-modern">
                                <h3 class="service-title-modern">{{ service.name }}</h3>

                                <!-- Provider Info -->
                                <div class="provider-badge">
                                    <i class="bi bi-person-circle"></i>
                                    <span>{{ service.provider.username }}</span>
                                </div>

                                <p class="service-desc-modern">{{ service.description|truncatewords:15 }}</p>

                                <!-- Service Meta -->
                                <div class="service-meta-modern">
                                    <div class="meta-badge">
                                        <i class="bi bi-clock-fill"></i>
                                        <span>{{ service.get_duration_display }}</span>
                                    </div>
                                    <div class="price-badge">
                                        <span class="price-label">Price</span>
                                        <span class="price-value">€{{ service.price }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Footer -->
                            <div class="card-footer-modern">
                                <a href="{% url 'view_availability' service.id %}" class="btn-book-modern">
                                    <span>View Availability</span>
                                    <i class="bi bi-calendar-check-fill"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <i class="bi bi-search"></i>
                    <h3>No Services Found</h3>
                    <p>Try adjusting your search filters or check back later for new services</p>
                    <a href="?" class="btn btn-primary mt-3">Clear Filters</a>
                </div>
            {% endif %}
        </div>
    </section>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript for sort and search -->
    <script>
        // Get form and sort dropdown
        const searchForm = document.querySelector('.search-form-modern');
        const sortDropdown = document.getElementById('sort_by');

        // Auto submit form when sort changes
        if (sortDropdown && searchForm) {
            sortDropdown.addEventListener('change', function() {
                // Create hidden inputs for current filters
                const category = document.getElementById('category').value;
                const search = document.getElementById('search').value;

                // Build URL with all parameters
                let url = '?';
                if (category) url += 'category=' + encodeURIComponent(category) + '&';
                if (search) url += 'search=' + encodeURIComponent(search) + '&';
                url += 'sort_by=' + this.value;

                // Navigate to new URL
                window.location.href = url;
            });
        }

        // Prevent providers from clicking "View Availability" - Show alert
        {% if user.is_authenticated and user.userprofile.user_type == 'provider' %}
        document.addEventListener('DOMContentLoaded', function() {
            const bookButtons = document.querySelectorAll('.btn-book-modern');
            bookButtons.forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('⚠️ Provider Account\n\nYou are logged in as a service provider. Providers cannot book services.\n\nOnly customer accounts can make bookings.');
                    return false;
                });
            });
        });
        {% endif %}
    </script>
</body>
</html>
